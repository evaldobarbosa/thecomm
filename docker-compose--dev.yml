version: "3.6"

services:
  web:
    image: ambientum/php:8.0-nginx
    restart: unless-stopped
    volumes:
      - ./webapp/:/var/www/app
      - ./ssl:/home/ambientum/ssl
    # ports:
    #   - 8000:8000
    environment:
      - FRAMEWORK=laravel
      - XDEBUG_ENABLED=false
      - OPCACHE_MODE=normal
      - PHP_MEMORY_LIMIT=256M
      - LANG=pt_BR.UTF-8
      - TZ=America/Fortaleza
    links:
      - db
    networks:
      - default
      - proxymng

  db:
    image: postgres:latest
    restart: unless-stopped
    volumes:
      - ./pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=thecomm
      - POSTGRES_PASSWORD=thecomm
      - POSTGRES_DB=thecomm
      - PGDATA=./pgdata
      - TZ=America/Fortaleza

  queue:
    image: ambientum/php:8.0-nginx
    restart: unless-stopped
    command: php artisan queue:work --tries=5 --sleep=5
    environment:
      - PHP_MEMORY_LIMIT=256M
      - LANG=pt_BR.UTF-8
      - TZ=America/Fortaleza
    volumes:
      - ./webapp/:/var/www/app
    depends_on:
      - web
    links:
      - db

  websocket:
    image: evaldobarbosa/thecomm-php8-nginx
    restart: unless-stopped
    command: php artisan websockets:serve
    environment:
      - PHP_MEMORY_LIMIT=256M
      - LANG=pt_BR.UTF-8
      - TZ=America/Fortaleza
    volumes:
      - ./webapp/:/var/www/app
      - ./ssl:/home/ambientum/ssl
    depends_on:
      - web
    links:
      - db

  # websocket:
  #   image: quay.io/soketi/soketi:latest-16-alpine
  #   restart: unless-stopped
  #   ports:
  #     - 6001:6001
  #   environment:
  #     - DEFAULT_APP_ID=TheComm123
  #     - DEFAULT_APP_KEY=s1234
  #     - DEFALT_APP_SECRET=5678
  #     - SOKETI_DEBUG=1

  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=evaldobarbosa@gmail.com
      - PGADMIN_DEFAULT_PASSWORD=teste123
      - PGADMIN_LISTEN_PORT=5050
    depends_on:
      - db
    networks:
      - default
      - proxymng

networks:
  default:
    driver: bridge
  proxymng:
    external: true
